# cJunosEvolved FlowSpec Lab
#
# Tests FlowSpec propagation: prefixd -> GoBGP -> cJunosEvolved
# cJunosEvolved is PTX-based Junos Evolved - Juniper's future direction
#
# IMPORTANT: Requires Intel CPU with nested virtualization (VMX).
#            Will NOT work on AMD CPUs. Use frr-flowspec.clab.yml instead.
#
# Prerequisites:
#   1. Intel CPU with nested virt: cat /sys/module/kvm_intel/parameters/nested
#   2. Download cJunosEvolved qcow2 from Juniper (free account)
#   3. Build vrnetlab image:
#      git clone https://github.com/hellt/vrnetlab.git ~/vrnetlab
#      cp cjunosevolved-*.qcow2 ~/vrnetlab/juniper/vjunosevolved/
#      cd ~/vrnetlab/juniper/vjunosevolved && make
#
# Usage:
#   sudo containerlab deploy -t cjunos-flowspec.clab.yml
#   # Wait ~15 min for router to boot (requires 8GB RAM)
#   sudo containerlab destroy -t cjunos-flowspec.clab.yml

name: cjunos-flowspec

mgmt:
  network: clab-mgmt-evo
  ipv4-subnet: 172.30.31.0/24

topology:
  nodes:
    # GoBGP - FlowSpec announcer (connected to prefixd)
    gobgp:
      kind: linux
      image: jauderho/gobgp:latest
      mgmt-ipv4: 172.30.31.2
      binds:
        - gobgp-cjunos.conf:/etc/gobgp/gobgp.conf:ro
      ports:
        - 50053:50051  # gRPC API for prefixd (50053 to avoid conflict)
      exec:
        - ip addr add 10.0.1.1/30 dev eth1
        - gobgpd -f /etc/gobgp/gobgp.conf -p --api-hosts=0.0.0.0:50051 &

    # cJunosEvolved - FlowSpec receiver/enforcer
    router:
      kind: juniper_vjunosevolved
      image: vrnetlab/juniper_vjunos-evolved:24.2R1.17
      mgmt-ipv4: 172.30.31.3
      startup-config: cjunos-config.txt

  links:
    # eBGP peering link between GoBGP and cJunosEvolved
    - endpoints: ["gobgp:eth1", "router:eth1"]
